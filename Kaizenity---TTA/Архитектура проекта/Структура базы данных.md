# Структура базы данных PostgreSQL - Kaizenity TTA

## Обзор базы данных

- **Сервер**: PostgreSQL 12.22 (Ubuntu)
- **База данных**: kaizenity
- **Размер**: 8.9 MB
- **Таблиц**: 7

## Схема базы данных

### 1. Таблица `conversations` (Разговоры)
**Назначение**: Хранение информации о разговорах/диалогах

**Структура**:
- `id` (bigint, PK) - Уникальный идентификатор разговора
- `source` (text, NOT NULL) - Источник разговора
- `chat_id` (bigint) - ID чата
- `thread_id` (bigint) - ID ветки обсуждения
- `root_external_id` (text) - Внешний ID корневого сообщения
- `task_id` (bigint) - Связанная задача
- `title` (text) - Заголовок разговора
- `meta` (jsonb) - Метаданные разговора
- `created_at` (timestamp) - Время создания
- `closed_at` (timestamp) - Время закрытия
- `merged_into` (bigint) - ID разговора, в который объединен

**Индексы**:
- `conversations_pkey` - Первичный ключ
- `idx_conversations_chat` - По источнику и чату
- `idx_conversations_task` - По задаче
- `idx_conversations_thread` - По ветке
- `ux_conversations_root` - Уникальный индекс по корневому сообщению

**Данные**: 1 запись, 96 kB

### 2. Таблица `doc_catalog` (Каталог документов)
**Назначение**: Каталогизация документов и объектов проекта

**Структура**:
- `id` (bigint, PK) - Уникальный идентификатор
- `project` (text, NOT NULL) - Название проекта
- `object_type` (text, NOT NULL) - Тип объекта
- `schema_name` (text) - Имя схемы
- `object_name` (text, NOT NULL) - Имя объекта
- `object_key` (text, NOT NULL) - Ключ объекта
- `parent_key` (text) - Ключ родительского объекта
- `object_oid` (bigint) - OID объекта
- `parent_oid` (bigint) - OID родительского объекта
- `attnum` (integer) - Номер атрибута
- `action` (text, NOT NULL) - Действие
- `title` (text) - Заголовок
- `rationale_md` (text) - Обоснование в Markdown
- `spec` (jsonb) - Спецификация
- `is_dropped` (boolean) - Флаг удаления
- `created_at` (timestamp) - Время создания

**Индексы**:
- `doc_catalog_pkey` - Первичный ключ
- `idx_doc_catalog_key` - По проекту, ключу и времени
- `idx_doc_catalog_type` - По типу объекта

**Данные**: 22 записи, 64 kB

### 3. Таблица `kznt_DF_executions` (Выполнения DF)
**Назначение**: Логирование выполнения Data Flow операций

**Структура**:
- `id` (bigint, PK) - Уникальный идентификатор
- `field_name` (text) - Имя поля
- `field_api_id` (text) - API ID поля
- `user_input` (text) - Ввод пользователя
- `created_on` (timestamp) - Время создания
- `extractor_output` (text) - Вывод экстрактора
- `editor_output` (text) - Вывод редактора
- `coach_questions` (ARRAY) - Вопросы коуча
- `coach_quality_score` (integer) - Оценка качества коуча
- `coach_quality_comments` (text) - Комментарии качества

**Индексы**:
- `kznt_DF_executions_pkey` - Первичный ключ

**Данные**: 15 записей, 88 kB

### 4. Таблица `message_tasks` (Связи сообщений и задач)
**Назначение**: Связывание сообщений с задачами

**Структура**:
- `message_id` (bigint, NOT NULL) - ID сообщения
- `task_id` (bigint, NOT NULL) - ID задачи
- `relation_type` (text, NOT NULL) - Тип связи
- `meta` (jsonb) - Метаданные
- `created_at` (timestamp) - Время создания

**Индексы**:
- `message_tasks_pkey` - Составной первичный ключ
- `idx_message_tasks_message` - По сообщению
- `idx_message_tasks_task` - По задаче
- `idx_message_tasks_task_type` - По задаче и типу

**Данные**: 1 запись, 80 kB

### 5. Таблица `messages` (Сообщения)
**Назначение**: Хранение всех сообщений системы

**Структура**:
- `id` (bigint, PK) - Уникальный идентификатор
- `source` (text, NOT NULL) - Источник сообщения
- `external_id` (text) - Внешний ID
- `chat_id` (bigint) - ID чата
- `user_id` (bigint) - ID пользователя
- `direction` (text, NOT NULL) - Направление (in/out)
- `task_id` (bigint) - Связанная задача
- `payload` (jsonb) - Полезная нагрузка
- `text` (text) - Текст сообщения
- `created_at` (timestamp) - Время создания
- `conversation_id` (bigint) - ID разговора
- `thread_id` (bigint) - ID ветки
- `external_reply_to_id` (text) - Внешний ID ответа
- `message_type` (text) - Тип сообщения
- `command` (text) - Команда
- `reply_to_message_id` (bigint) - ID сообщения-ответа
- `media` (jsonb) - Медиафайлы
- `photo` (jsonb) - Фотографии

**Индексы**:
- `messages_pkey` - Первичный ключ
- `idx_messages_chat_ext_reply` - По чату и внешнему ответу
- `idx_messages_conversation` - По разговору
- `idx_messages_payload_gin` - GIN индекс по payload
- `idx_messages_source` - По источнику
- `idx_messages_task` - По задаче
- `idx_messages_thread` - По ветке
- `idx_messages_user` - По пользователю
- `ux_messages_source_chat_ext` - Уникальный индекс

**Данные**: 1 запись, 184 kB

### 6. Таблица `task_execution_log` (Лог выполнения задач)
**Назначение**: Логирование выполнения задач

**Структура**:
- `id` (bigint, PK) - Уникальный идентификатор
- `task_id` (bigint, NOT NULL) - ID задачи
- `execution_id` (uuid, NOT NULL) - ID выполнения
- `step_number` (integer, NOT NULL) - Номер шага
- `at` (timestamp) - Время события
- `level` (text) - Уровень логирования
- `message` (text) - Сообщение
- `payload` (jsonb) - Дополнительные данные

**Индексы**:
- `task_execution_log_pkey` - Первичный ключ
- `idx_tel_execution_id` - По ID выполнения
- `idx_tel_task_id` - По ID задачи
- `idx_tel_task_step` - По задаче и шагу

**Данные**: 0 записей, 40 kB

### 7. Таблица `tasks` (Задачи)
**Назначение**: Основная таблица задач системы

**Структура**:
- `id` (bigint, PK) - Уникальный идентификатор
- `title` (text, NOT NULL) - Заголовок задачи
- `instruction_md` (text) - Инструкции в Markdown
- `process` (jsonb) - Процесс выполнения
- `full_response_format` (jsonb) - Формат полного ответа
- `current_state` (text) - Текущее состояние
- `status` (text, NOT NULL) - Статус задачи
- `created_at` (timestamp) - Время создания
- `updated_at` (timestamp) - Время обновления
- `parent_task_id` (bigint) - ID родительской задачи
- `attempts` (integer) - Количество попыток
- `last_error` (jsonb) - Последняя ошибка
- `locked_at` (timestamp) - Время блокировки
- `state_version` (integer) - Версия состояния
- `result` (jsonb) - Результат
- `history` (jsonb) - История изменений
- `wakeup_at` (timestamp) - Время пробуждения
- `asked_at` (timestamp) - Время запроса
- `pending_children_count` (integer) - Количество ожидающих дочерних задач
- `children_status_summary` (jsonb) - Сводка статусов дочерних задач
- `last_activity_at` (timestamp) - Время последней активности
- `execution_id` (uuid) - ID выполнения
- `started_at` (timestamp) - Время начала
- `finalized_at` (timestamp) - Время завершения
- `waiting_channel` (text) - Канал ожидания
- `waiting_address` (text) - Адрес ожидания
- `awaiting_from_user_id` (bigint) - Ожидание от пользователя
- `sent_message_id` (text) - ID отправленного сообщения
- `timeout_at` (timestamp) - Время таймаута
- `waiting_payload` (jsonb) - Полезная нагрузка ожидания
- `last_reminder_at` (timestamp) - Время последнего напоминания
- `waiting_attempts` (integer) - Количество попыток ожидания

**Индексы**:
- `tasks_pkey` - Первичный ключ
- `idx_tasks_awaiting_human` - По ожиданию человека
- `idx_tasks_current_state` - По текущему состоянию
- `idx_tasks_parent` - По родительской задаче
- `idx_tasks_process_gin` - GIN индекс по процессу
- `idx_tasks_status` - По статусу
- `idx_tasks_timeout_at` - По времени таймаута
- `idx_tasks_wakeup_at` - По времени пробуждения

**Данные**: 1 запись, 160 kB

## Связи между таблицами

```
tasks (1) ←→ (N) messages
tasks (1) ←→ (N) task_execution_log
tasks (1) ←→ (N) message_tasks ←→ (1) messages
conversations (1) ←→ (N) messages
```

## Особенности архитектуры

1. **JSONB поля** - Используются для гибкого хранения структурированных данных
2. **GIN индексы** - Для эффективного поиска по JSONB полям
3. **Временные метки** - Все таблицы имеют поля создания/обновления
4. **Иерархия задач** - Поддержка родительско-дочерних связей
5. **Внешние интеграции** - Поддержка внешних ID для интеграции с мессенджерами

---

*Документ создан на основе анализа базы данных от $(date)*
